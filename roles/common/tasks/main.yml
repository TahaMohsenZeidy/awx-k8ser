#SPDX-License-Identifier: MIT-0
---

# update records in /etc/hosts
- name: Updating records in /etc/hosts
  lineinfile:
    path: /etc/hosts
    line: "{{ item.ip }} {{ item.name }}"
  with_items:
    - { name: "ubuntu-master", ip: "192.168.11.144" }
    - { name: "ubuntu-worker", ip: "192.168.11.142" }

# Disable Swap
- name: Disable Swap
  shell: swapoff -a
  
# Load kernel modules
- name: Load kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  with_items:
    - br_netfilter
    - overlay

# make kernel modules persistent
- name: Make the Kernel modules persistent
  lineinfile:
    path: /etc/modules-load.d/containerd.conf
    create: yes
    owner: root
    group: root
    mode: '0644'
    line: "{{ item }}"
  with_items:
    - br_netfilter
    - overlay

# Add extra kernel parameters 
- name: Add extra kernel parameters
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: yes
    state: present
    reload: yes
  with_items:
    - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { name: 'net.ipv4.ip_forward', value: '1' }

# Install prerequisites
- name: Install required packages
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes

# Add Docker GPG key
- name: Add Docker GPG key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

# Add Docker repository
- name: Add Docker repository
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
    filename: docker

# Install Containerd.io
- name: Install Containerd.io
  apt:
    name: containerd.io
    state: present
    update_cache: yes

# Generate default containerd config file
- name: Generate default containerd.io config file
  shell: sudo containerd config default | sudo tee /etc/containerd/config.toml
  args:
    creates: /etc/containerd/config.toml

# Configure containerd to use systemd cgroup driver
- name: Configure containerd to use systemd cgroup driver
  replace:
    path: /etc/containerd/config.toml
    regexp: 'SystemdCgroup\s*=\s*false'
    replace: 'SystemdCgroup = true'
  notify: restart containerd

# Add Kubernetes GPG key
- name: Add Kubernetes GPG key
  apt_key:
    url: https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key
    state: present
    keyring: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# Add Kubernetes repository
- name: Add Kubernetes repository
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /"
    state: present
    filename: kubernetes

# Install Kubernetes packages
- name: Install Kubernetes packages
  apt:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present
    update_cache: yes

# Hold Kubernetes packages at current version
- name: Hold Kubernetes packages
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  with_items:
    - kubelet
    - kubeadm
    - kubectl